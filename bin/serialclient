#!/usr/bin/ruby 

require 'rubygems'
require 'serialport'
require 'rink'
require 'micro-optparse'


options = Parser.new do |p|
  p.banner = "Serial terminal client"
  p.option :port, "path to serial device, ex: /dev/ttyUSB0", :default => ""
  p.option :speed, "speed in baups", :default => 115200 
end.process!

class Serial_client < Rink::Console
  option :allow_ruby => false

  def initialize (port_, baup_)
    @sp = SerialPort.new port_, baup_
    @read_th = Thread.new {
      while 1 do
        puts @sp.gets
      end
    }
    super()
  end

  def process_line (line_)
    @sp.write(line_+ "\n")
    sleep 0.01
  end

end

Signal.trap('TERM') do
  puts "\n"
  Process.exit 0
end

Signal.trap('INT') do 
  puts "\n"
  Process.exit 0
end


Serial_client.new(options[:port], options[:speed])
